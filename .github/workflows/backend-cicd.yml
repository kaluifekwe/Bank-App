name: Bank Backend API Pipeline

on:
  workflow_dispatch:
  repository_dispatch:
    types: [backend-build]
  push:
    branches:
      - main
    paths:
      - 'backend/**'

jobs:
  build-and-deploy:
    runs-on: self-hosted
    

    steps:
      - name: Checkout (clean workspace)
        uses: actions/checkout@v3
        with:
          clean: true

      - name: Print workspace directory
        run: pwd

      - name: List contents before cleanup
        run: |
          ls -al || dir

      - name: Clean up old manifest directory (cross-platform)
        shell: bash
        run: |
          if [ -d "${{ github.workspace }}/kubernetes-manifest-bank_app" ]; then
            echo "Removing (bash): ${{ github.workspace }}/kubernetes-manifest-bank_app"
            rm -rf "${{ github.workspace }}/kubernetes-manifest-bank_app"
          elif [ -d "kubernetes-manifest-bank_app" ]; then
            echo "Removing (bash): kubernetes-manifest-bank_app"
            rm -rf "kubernetes-manifest-bank_app"
          elif command -v pwsh >/dev/null 2>&1; then
            echo "Trying PowerShell removal..."
            pwsh -Command "if (Test-Path '${{ github.workspace }}\\kubernetes-manifest-bank_app') { Remove-Item -Recurse -Force '${{ github.workspace }}\\kubernetes-manifest-bank_app' }"
            pwsh -Command "if (Test-Path 'kubernetes-manifest-bank_app') { Remove-Item -Recurse -Force 'kubernetes-manifest-bank_app' }"
          else
            echo "No manifest directory found to remove."
          fi

      - name: List contents after cleanup
        run: |
          ls -al || dir

      - name: Checkout Backend Repository
        uses: actions/checkout@v3
        with:
          repository: kaluifekwe/Bank_app_backend
          token: ${{ secrets.GIT_PASSWORD }}
          path: backend_src

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        working-directory: backend_src
        run: mvn clean package -DskipTests

      - name: Build Docker Image
        working-directory: backend_src
        run: |
          docker build -t bank-backendapi:${{ github.sha }} .
          docker tag bank-backendapi:${{ github.sha }} bank-backendapi:latest

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 029373387388.dkr.ecr.us-east-1.amazonaws.com

      - name: Tag and Push to ECR
        run: |
          docker tag bank-backendapi:latest 029373387388.dkr.ecr.us-east-1.amazonaws.com/bank-backendapi:${{ github.sha }}
          docker tag bank-backendapi:latest 029373387388.dkr.ecr.us-east-1.amazonaws.com/bank-backendapi:latest
          docker push 029373387388.dkr.ecr.us-east-1.amazonaws.com/bank-backendapi:${{ github.sha }}
          docker push 029373387388.dkr.ecr.us-east-1.amazonaws.com/bank-backendapi:latest

      - name: Update Kubernetes Manifests
        run: |
          git clone https://${{ secrets.GIT_USERNAME }}:${{ secrets.GIT_PASSWORD }}@github.com/kaluifekwe/kubernetes-manifest-bank_app.git
          cd kubernetes-manifest-bank_app
          sed -i "s|image: 029373387388.dkr.ecr.us-east-1.amazonaws.com/bank-backendapi:.*|image: 029373387388.dkr.ecr.us-east-1.amazonaws.com/bank-backendapi:${{ github.sha }}|g" bank-project/backendapi.yaml
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add bank-project/backendapi.yaml
          git commit -m "Update backend image to ${{ github.sha }}"
          git push
        env:
          GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
          GIT_PASSWORD: ${{ secrets.GIT_PASSWORD }}
